```{r}

library(tidyverse)
library(here)
library(gtsummary) # Automates the stats
library(rstatix)   # For specific pairwise comparisons
library(gt)

# 1. Load Data
# Load the metadata that HAS the cluster column (from step 01)
sampleInfo <- readRDS(here("sandbox","sadegh","results", "sampleInfo_with_clusters.rds"))

# Filter to just DCM samples (the ones we clustered)
dcm_data <- sampleInfo %>% 
  filter(!is.na(DCM_Subtype))

# 2. METHOD A: The "All-in-One" Table (Best for Overview)
# This generates a table comparing Cluster 1 vs 2 vs 3 with p-values

validation_table <- dcm_data %>%
  select(DCM_Subtype, gender, age, LVEF, race, bmi) %>%
  tbl_summary(
    by = DCM_Subtype, # Group by our new clusters
    statistic = list(all_continuous() ~ "{mean} ({sd})", 
                     all_categorical() ~ "{n} / {N} ({p}%)"),
    missing = "no"
  ) %>%
  add_p(pvalue_fun = ~style_pvalue(.x, digits=3)) %>% # Adds Chi-sq/Kruskal-Wallis p-values
  add_overall() %>%
  modify_caption("**Table: Clinical Characteristics of DCM Molecular Subtypes**") %>%
  bold_labels()

# Save the table
validation_table %>%
  as_gt() %>%
  gtsave(filename = here("sandbox","sadegh","tables", "Cluster_Validation_Table.pdf"))

print("Table saved to tables/Cluster_Validation_Table.pdf")


# 3. METHOD B: Specific Statistical Tests (For your Manuscript Text)

# --- TEST 1: IS SEX DRIVING THE CLUSTERS? (Chi-Square) ---
print("--- TEST 1: GENDER DISTRIBUTION ---")
sex_table <- table(dcm_data$DCM_Subtype, dcm_data$gender)
print(sex_table)

chisq_sex <- chisq.test(sex_table)
print(chisq_sex)

if(chisq_sex$p.value < 0.05) {
  print("SIGNIFICANT: The clusters are strongly driven by Sex.")
}

# --- TEST 2: IS THERE A SEVERITY DIFFERENCE (LVEF)? (ANOVA) ---
print("--- TEST 2: LVEF DIFFERENCES (ANOVA) ---")
# ANOVA to see if means differ
anova_res <- aov(LVEF ~ DCM_Subtype, data = dcm_data)
summary(anova_res)

# Post-Hoc Tukey Test (To see WHICH cluster is different)
# This tells you if Cluster 1 is different from Cluster 3 specifically
tukey_res <- TukeyHSD(anova_res)
print(tukey_res)


# 4. VISUALIZATION (Boxplots for the Paper)
# LVEF Boxplot
plot_lvef <- ggplot(dcm_data, aes(x=DCM_Subtype, y=LVEF, fill=DCM_Subtype)) +
  geom_boxplot() +
  geom_jitter(width=0.2, alpha=0.5) +
  theme_minimal() +
  labs(title = "Heart Function (LVEF) by Molecular Subtype",
       subtitle = paste("ANOVA p-value:", signif(summary(anova_res)[[1]][["Pr(>F)"]][1], 3)))

ggsave(here("sandbox","sadegh","plots", "Validation_LVEF.pdf"), plot_lvef, width=6, height=4)

# Age Boxplot
plot_age <- ggplot(dcm_data, aes(x=DCM_Subtype, y=age, fill=DCM_Subtype)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Age Distribution by Molecular Subtype")

ggsave(here("sandbox","sadegh","plots", "Validation_Age.pdf"), plot_age, width=6, height=4)

```






